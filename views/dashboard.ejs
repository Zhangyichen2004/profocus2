<!-- views/dashboard.ejs -->
<%- include('partials/header') %>

<h1 class="mb-4">Dashboard</h1>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">My Goals</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addGoalModal">
                    Add Goal
                </button>
            </div>
            <div class="card-body">
                <% if(goals.length > 0) { %>
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Deadline</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <% goals.forEach(goal => { %>
                            <tr>
                                <td><%= goal.title %></td>
                                <td><%= goal.category || 'N/A' %></td>
                                <td>
                    <span class="badge <%= goal.priority === 'High' ? 'bg-danger' : goal.priority === 'Medium' ? 'bg-warning' : 'bg-info' %>">
                      <%= goal.priority %>
                    </span>
                                </td>
                                <td>
                    <span class="badge <%= goal.status === 'Completed' ? 'bg-success' : goal.status === 'In Progress' ? 'bg-primary' : 'bg-secondary' %>">
                      <%= goal.status %>
                    </span>
                                </td>
                                <td><%= goal.deadline ? new Date(goal.deadline).toLocaleDateString() : 'No deadline' %></td>
                                <td>
                                    <button class="btn btn-sm btn-info edit-goal" data-id="<%= goal.id %>" data-title="<%= goal.title %>" data-description="<%= goal.description %>" data-category="<%= goal.category %>" data-priority="<%= goal.priority %>" data-status="<%= goal.status %>" data-deadline="<%= goal.deadline ? goal.deadline : '' %>">
                                        Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-goal" data-id="<%= goal.id %>">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        <% }); %>
                        </tbody>
                    </table>
                <% } else { %>
                    <p>You have no goals yet. Click the "Add Goal" button to get started.</p>
                <% } %>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Goal Status</h5>
            </div>
            <div class="card-body">
                <canvas id="goalStatusChart"></canvas>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Focus Time</h5>
            </div>
            <div class="card-body">
                <p>Start a Pomodoro session to track your focus time.</p>
                <a href="/timer" class="btn btn-primary">Go to Timer</a>
            </div>
        </div>
    </div>
</div>

<!-- Add Goal Modal -->
<div class="modal fade" id="addGoalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addGoalForm" action="/goals" method="POST">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <input type="text" class="form-control" id="category" name="category">
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-control" id="priority" name="priority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="deadline" class="form-label">Deadline (optional)</label>
                        <input type="date" class="form-control" id="deadline" name="deadline">
                    </div>
                    <button type="submit" class="btn btn-primary">Add Goal</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Goal Modal -->
<div class="modal fade" id="editGoalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <!-- views/dashboard.ejs (continued) -->
                <h5 class="modal-title">Edit Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editGoalForm" method="POST">
                    <input type="hidden" id="edit-goal-id" name="id">
                    <div class="mb-3">
                        <label for="edit-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="edit-title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit-category" class="form-label">Category</label>
                        <input type="text" class="form-control" id="edit-category" name="category">
                    </div>
                    <div class="mb-3">
                        <label for="edit-priority" class="form-label">Priority</label>
                        <select class="form-control" id="edit-priority" name="priority">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-status" class="form-label">Status</label>
                        <select class="form-control" id="edit-status" name="status">
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-deadline" class="form-label">Deadline (optional)</label>
                        <input type="date" class="form-control" id="edit-deadline" name="deadline">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Goal</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Goal Modal -->
<div class="modal fade" id="deleteGoalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this goal? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteGoalForm" method="POST">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Goal Status Chart
    const statusCounts = {
        Pending: <%= goals.filter(goal => goal.status === 'Pending').length %>,
        'In Progress': <%= goals.filter(goal => goal.status === 'In Progress').length %>,
        Completed: <%= goals.filter(goal => goal.status === 'Completed').length %>
    };

    const ctx = document.getElementById('goalStatusChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(statusCounts),
            datasets: [{
                data: Object.values(statusCounts),
                backgroundColor: ['#6c757d', '#007bff', '#28a745']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Edit Goal Modal
    document.querySelectorAll('.edit-goal').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            const title = e.target.dataset.title;
            const description = e.target.dataset.description;
            const category = e.target.dataset.category;
            const priority = e.target.dataset.priority;
            const status = e.target.dataset.status;
            const deadline = e.target.dataset.deadline;

            document.getElementById('edit-goal-id').value = id;
            document.getElementById('edit-title').value = title;
            document.getElementById('edit-description').value = description;
            document.getElementById('edit-category').value = category;
            document.getElementById('edit-priority').value = priority;
            document.getElementById('edit-status').value = status;
            document.getElementById('edit-deadline').value = deadline;

            const form = document.getElementById('editGoalForm');
            form.action = `/goals/${id}?_method=PUT`;

            const editGoalModal = new bootstrap.Modal(document.getElementById('editGoalModal'));
            editGoalModal.show();
        });
    });

    // Delete Goal Modal
    document.querySelectorAll('.delete-goal').forEach(button => {
        button.addEventListener('click', (e) => {
            const id = e.target.dataset.id;

            const form = document.getElementById('deleteGoalForm');
            form.action = `/goals/${id}?_method=DELETE`;

            const deleteGoalModal = new bootstrap.Modal(document.getElementById('deleteGoalModal'));
            deleteGoalModal.show();
        });
    });
</script>

<%- include('partials/footer') %>